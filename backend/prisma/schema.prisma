datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  name         String
  role         String
  createdAt    DateTime @default(now())
  deviceTokens DeviceToken[]
  notifications Notification[]
}

model Station {
  id            Int      @id @default(autoincrement())
  name          String
  address       String
  lat           Float
  lng           Float
  stock         Int
  price         Float
  officialPrice Float
  history       Json
  lastAudit     DateTime?
  status        String
  audits        Audit[]
  complaints    Complaint[]
  transactions  Transaction[]
}

model Audit {
  id            Int      @id @default(autoincrement())
  stationId     Int
  station       Station  @relation(fields: [stationId], references: [id])
  code          String
  status        String
  priceExpected Float
  priceReported Float
  dispenserOk   Boolean
  createdAt     DateTime @default(now())
}

model Complaint {
  id             Int      @id @default(autoincrement())
  stationName    String
  stationId      Int?
  station        Station? @relation(fields: [stationId], references: [id])
  type           String
  detail         String?
  source         String?
  reporterName   String?
  reporterRole   String?
  vehiclePlate   String?
  vehicleModel   String?
  fuelType       String?
  vehicleId      Int?
  vehicle        Vehicle? @relation(fields: [vehicleId], references: [id])
  liters         Float?
  unitPrice      Float?
  totalAmount    Float?
  occurredAt     DateTime?
  transactionId  Int?
  transaction    Transaction? @relation(fields: [transactionId], references: [id])
  photoUrl       String?
  status         String
  resolvedAt     DateTime?
  resolutionNote String?
  createdAt      DateTime @default(now())
}

model Report {
  id        Int      @id @default(autoincrement())
  period    String
  format    String
  createdAt DateTime @default(now())
  sizeMb    Float
  fileUrl   String?
  mimeType  String?
}

model Vehicle {
  id             Int           @id @default(autoincrement())
  plate          String        @unique
  model          String
  capacityLiters Float
  fuelType       String
  ownerName      String?
  createdAt      DateTime      @default(now())
  transactions   Transaction[]
  complaints     Complaint[]
}

model Transaction {
  id           Int       @id @default(autoincrement())
  stationId    Int
  station      Station   @relation(fields: [stationId], references: [id])
  vehicleId    Int
  vehicle      Vehicle   @relation(fields: [vehicleId], references: [id])
  liters       Float
  unitPrice    Float
  totalAmount  Float
  paymentMethod String?
  reportedBy   String?
  occurredAt   DateTime  @default(now())
  createdAt    DateTime  @default(now())
  complaints   Complaint[]
}

model DeviceToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform  String
  token     String   @unique
  active    Boolean  @default(true)
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  title     String
  body      String
  data      Json?
  status    String   @default("queued")
  error     String?
  createdAt DateTime @default(now())
  sentAt    DateTime?
}
